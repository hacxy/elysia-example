name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_ENV: production

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate .env file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          cat .env

      # - name: Generate Prisma Client
      #   run: bunx prisma generate
      #   continue-on-error: true

      - name: Build application for Linux
        run: |
          bun run prisma:generate &&
          bun run build:linux

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: |
            server
            .env
            package.json
            prisma
          retention-days: 7

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-build
          path: ./artifacts

      - name: Deploy application files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          # key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "artifacts/server,artifacts/package.json,artifacts/prisma"
          target: ${{ secrets.SERVER_DEPLOY_PATH }}

      - name: Execute deployment commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          # key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            SERVICE_NAME="${{ secrets.SERVICE_NAME || 'elysia-example' }}"

            echo "ðŸ“¦ å¼€å§‹éƒ¨ç½²åˆ° ${{ secrets.SERVER_DEPLOY_PATH }}"
            cd ${{ secrets.SERVER_DEPLOY_PATH }}

            # åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}
            mkdir -p ${{ secrets.SERVER_DEPLOY_PATH }}/backups

            # å¤‡ä»½æ—§ç‰ˆæœ¬
            if [ -f server ]; then
              BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              cp server "$BACKUP_DIR/" 2>/dev/null || true
              echo "âœ… å·²å¤‡ä»½æ—§ç‰ˆæœ¬åˆ° $BACKUP_DIR"
            fi

            # è®¾ç½®æ‰§è¡Œæƒé™
            chmod +x ${{ secrets.SERVER_DEPLOY_PATH }}/artifacts/server || true

            sudo systemctl daemon-reload
            sudo systemctl enable "${SERVICE_NAME}.service" || true


            # åœæ­¢çŽ°æœ‰æœåŠ¡ï¼ˆå¦‚æžœæ­£åœ¨è¿è¡Œï¼‰
            echo "â¹ï¸  åœæ­¢çŽ°æœ‰æœåŠ¡..."
            if sudo systemctl is-active --quiet "${SERVICE_NAME}.service" 2>/dev/null; then
              sudo systemctl stop "${SERVICE_NAME}.service" || true
            fi

            # è¿è¡Œ Prisma è¿ç§»ï¼ˆå¦‚æžœéœ€è¦ï¼‰
            if [ -d prisma ]; then
              echo "ðŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
              if command -v bun &> /dev/null; then
                bunx prisma migrate deploy || echo "âš ï¸  è¿ç§»å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²..."
              else
                echo "âš ï¸  æœªå®‰è£… Bunï¼Œè·³è¿‡æ•°æ®åº“è¿ç§»"
              fi
            fi

            # æ£€æŸ¥å¹¶åˆ›å»º .env æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            cd ${{ secrets.SERVER_DEPLOY_PATH }}/artifacts 
            if [ ! -f ".env" ]; then
              echo "ðŸ“ æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨ .env æ–‡ä»¶ï¼Œæ­£åœ¨åˆ›å»º..."
              cat > .env << EOF
              DATABASE_URL=${{ secrets.DATABASE_URL }}
              SECRET_KEY=${{ secrets.SECRET_KEY }}
              EOF
              # æ›¿æ¢å˜é‡å€¼
              sed -i "s|\${{ secrets.DATABASE_URL }}|${{ secrets.DATABASE_URL }}|g" .env
              sed -i "s|\${{ secrets.SECRET_KEY }}|${{ secrets.SECRET_KEY }}|g" .env
              chmod 600 .env
              echo "âœ… å·²åˆ›å»º .env æ–‡ä»¶"
            else
              echo "âœ… æœåŠ¡å™¨ä¸Šå·²å­˜åœ¨ .env æ–‡ä»¶ï¼Œè·³è¿‡åˆ›å»º"
            fi

            # å¯åŠ¨æœåŠ¡
            echo "â–¶ï¸  å¯åŠ¨æœåŠ¡..."
            sudo systemctl start "${SERVICE_NAME}.service" || {
              echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
              sudo systemctl status "${SERVICE_NAME}.service" --no-pager -l || true
              # å°è¯•å›žæ»š
              if [ -d "$BACKUP_DIR" ] && [ -f "$BACKUP_DIR/server" ]; then
                echo "ðŸ”„ å°è¯•å›žæ»šåˆ°æ—§ç‰ˆæœ¬..."
                cp "$BACKUP_DIR/server" server
                sudo systemctl start "${SERVICE_NAME}.service" || true
              fi
              exit 1
            }

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if sudo systemctl is-active --quiet "${SERVICE_NAME}.service"; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              sudo systemctl status "${SERVICE_NAME}.service" --no-pager -l
            else
              echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
              echo "ðŸ“‹ æœåŠ¡çŠ¶æ€ï¼š"
              sudo systemctl status "${SERVICE_NAME}.service" --no-pager -l || true
              echo "ðŸ“‹ æœ€è¿‘æ—¥å¿—ï¼š"
              sudo journalctl -u "${SERVICE_NAME}.service" -n 50 --no-pager || true
              exit 1
            fi
