name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_ENV: production

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      # - name: Generate Prisma Client
      #   run: bunx prisma generate
      #   continue-on-error: true

      - name: Build application for Linux
        run: bun run build:linux

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: |
            server
            package.json
          retention-days: 7

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-build
          path: ./artifacts

      - name: Deploy application files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          # key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "artifacts/*"
          target: ${{ secrets.SERVER_DEPLOY_PATH }}

      - name: Deploy systemd service file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          # key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "deploy/elysia-app.service"
          target: /tmp/

      - name: Execute deployment commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          # key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.SERVER_DEPLOY_PATH }}"
            SERVICE_NAME="${{ secrets.SERVICE_NAME || 'elysia-app' }}"

            echo "ğŸ“¦ å¼€å§‹éƒ¨ç½²åˆ° $DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            # åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p "$DEPLOY_PATH"
            mkdir -p "$DEPLOY_PATH/backups"

            # å¤‡ä»½æ—§ç‰ˆæœ¬
            if [ -f server ]; then
              BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              cp server "$BACKUP_DIR/" 2>/dev/null || true
              echo "âœ… å·²å¤‡ä»½æ—§ç‰ˆæœ¬åˆ° $BACKUP_DIR"
            fi

            # è®¾ç½®æ‰§è¡Œæƒé™
            chmod +x server || true

            # å®‰è£…å’Œé…ç½® systemd æœåŠ¡
            echo "ğŸ”§ é…ç½® systemd æœåŠ¡..."
            SERVICE_FILE="/tmp/elysia-app.service"

            if [ -f "$SERVICE_FILE" ]; then
              # æ›´æ–°æœåŠ¡æ–‡ä»¶ä¸­çš„è·¯å¾„
              sed -i "s|WorkingDirectory=.*|WorkingDirectory=$DEPLOY_PATH|g" "$SERVICE_FILE"
              sed -i "s|ExecStart=.*|ExecStart=$DEPLOY_PATH/server|g" "$SERVICE_FILE"
              
              # å¤åˆ¶æœåŠ¡æ–‡ä»¶åˆ° systemd ç›®å½•
              sudo cp "$SERVICE_FILE" "/etc/systemd/system/${SERVICE_NAME}.service"
              
              # é‡æ–°åŠ è½½ systemd
              sudo systemctl daemon-reload
              
              # å¯ç”¨æœåŠ¡ï¼ˆå¦‚æœå°šæœªå¯ç”¨ï¼‰
              sudo systemctl enable "${SERVICE_NAME}.service" || true
              
              echo "âœ… æœåŠ¡æ–‡ä»¶å·²å®‰è£…"
            else
              echo "âš ï¸  æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºåŸºæœ¬æœåŠ¡é…ç½®"
              # å¦‚æœæœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªåŸºæœ¬é…ç½®
              cat <<EOF | sudo tee "/etc/systemd/system/${SERVICE_NAME}.service" > /dev/null
            [Unit]
            Description=Elysia App Server
            After=network.target

            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=$DEPLOY_PATH
            ExecStart=$DEPLOY_PATH/server
            Restart=always
            RestartSec=10
            StandardOutput=journal
            StandardError=journal
            SyslogIdentifier=${SERVICE_NAME}

            Environment=NODE_ENV=production
            Environment=PORT=1118

            [Install]
            WantedBy=multi-user.target
            EOF
              sudo systemctl daemon-reload
              sudo systemctl enable "${SERVICE_NAME}.service" || true
            fi

            # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
            if sudo systemctl list-unit-files | grep -q "${SERVICE_NAME}.service"; then
              echo "âœ… æœåŠ¡å·²é…ç½®"
            else
              echo "âŒ æœåŠ¡é…ç½®å¤±è´¥"
              exit 1
            fi

            # åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
            echo "â¹ï¸  åœæ­¢ç°æœ‰æœåŠ¡..."
            if sudo systemctl is-active --quiet "${SERVICE_NAME}.service" 2>/dev/null; then
              sudo systemctl stop "${SERVICE_NAME}.service" || true
            fi

            # è¿è¡Œ Prisma è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [ -d prisma ]; then
              echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
              if command -v bun &> /dev/null; then
                bunx prisma migrate deploy || echo "âš ï¸  è¿ç§»å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²..."
              else
                echo "âš ï¸  æœªå®‰è£… Bunï¼Œè·³è¿‡æ•°æ®åº“è¿ç§»"
              fi
            fi

            # å¯åŠ¨æœåŠ¡
            echo "â–¶ï¸  å¯åŠ¨æœåŠ¡..."
            sudo systemctl start "${SERVICE_NAME}.service" || {
              echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
              sudo systemctl status "${SERVICE_NAME}.service" --no-pager -l || true
              # å°è¯•å›æ»š
              if [ -d "$BACKUP_DIR" ] && [ -f "$BACKUP_DIR/server" ]; then
                echo "ğŸ”„ å°è¯•å›æ»šåˆ°æ—§ç‰ˆæœ¬..."
                cp "$BACKUP_DIR/server" server
                sudo systemctl start "${SERVICE_NAME}.service" || true
              fi
              exit 1
            }

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if sudo systemctl is-active --quiet "${SERVICE_NAME}.service"; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              sudo systemctl status "${SERVICE_NAME}.service" --no-pager -l
            else
              echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
              echo "ğŸ“‹ æœåŠ¡çŠ¶æ€ï¼š"
              sudo systemctl status "${SERVICE_NAME}.service" --no-pager -l || true
              echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—ï¼š"
              sudo journalctl -u "${SERVICE_NAME}.service" -n 50 --no-pager || true
              exit 1
            fi
